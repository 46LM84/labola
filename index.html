<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Centro Sportivo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-box h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #1e3c72;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e1e1;
            border-radius: 10px;
            font-size: 16px;
        }

        .btn {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        .btn:hover {
            opacity: 0.9;
        }

        /* Main App */
        .app-container {
            display: none;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            color: #1e3c72;
            font-size: 32px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logout-btn {
            background: #dc3545;
            padding: 10px 20px;
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
        }

        /* Field Tabs */
        .field-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .field-tab {
            background: white;
            padding: 15px 25px;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            border: 3px solid transparent;
        }

        .field-tab:hover {
            transform: translateY(-2px);
        }

        .field-tab.active {
            border-color: #2a5298;
            background: #e3f2fd;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .view-btn {
            background: #6c757d;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .view-btn.active {
            background: #2a5298;
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .content-section.active {
            display: block;
        }

        /* Weekly Calendar */
        .weekly-calendar {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .weekly-wrapper {
            position: relative;
            min-height: 600px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .weekly-wrapper.tennis {
            background: linear-gradient(rgba(255,255,255,0.92), rgba(255,255,255,0.92)),
                        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><pattern id="court" x="0" y="0" width="100%" height="100%"><rect fill="%234a7c59" width="1200" height="400"/><rect fill="%23d2691e" y="400" width="1200" height="400"/><rect x="50" y="50" width="1100" height="700" fill="none" stroke="white" stroke-width="5"/><line x1="50" y1="400" x2="1150" y2="400" stroke="white" stroke-width="5"/><line x1="600" y1="50" x2="600" y2="750" stroke="white" stroke-width="3"/><rect x="50" y="200" width="300" height="400" fill="none" stroke="white" stroke-width="3"/><rect x="850" y="200" width="300" height="400" fill="none" stroke="white" stroke-width="3"/><rect x="450" y="300" width="300" height="200" fill="none" stroke="white" stroke-width="2"/></pattern></defs><rect width="100%" height="100%" fill="url(%23court)"/></svg>');
        }

        .weekly-wrapper.calcio8 {
            background: linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,0.9)),
                        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><radialGradient id="grass"><stop offset="0%" style="stop-color:%23228b22"/><stop offset="100%" style="stop-color:%231f5f1f"/></radialGradient></defs><rect fill="url(%23grass)" width="1200" height="800"/><g stroke="white" fill="none"><rect x="50" y="50" width="1100" height="700" stroke-width="5"/><line x1="600" y1="50" x2="600" y2="750" stroke-width="4"/><circle cx="600" cy="400" r="90" stroke-width="4"/><circle cx="600" cy="400" r="5" fill="white"/><rect x="50" y="200" width="200" height="400" stroke-width="4"/><rect x="950" y="200" width="200" height="400" stroke-width="4"/><path d="M 50 300 a 100 100 0 0 0 0 200" stroke-width="3"/><path d="M 1150 300 a 100 100 0 0 1 0 200" stroke-width="3"/><rect x="50" y="325" width="60" height="150" stroke-width="3"/><rect x="1090" y="325" width="60" height="150" stroke-width="3"/></g></svg>');
        }

        .weekly-wrapper.padel {
            background: linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,0.9)),
                        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><linearGradient id="blue" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:%232196F3"/><stop offset="100%" style="stop-color:%231976D2"/></linearGradient></defs><rect fill="url(%23blue)" width="1200" height="800"/><g stroke="white" fill="none"><rect x="150" y="100" width="900" height="600" stroke-width="6"/><line x1="150" y1="400" x2="1050" y2="400" stroke-width="4"/><line x1="600" y1="100" x2="600" y2="700" stroke-width="3" stroke-dasharray="10,5"/><rect x="150" y="300" width="150" height="200" stroke-width="3"/><rect x="900" y="300" width="150" height="200" stroke-width="3"/><rect x="525" y="350" width="150" height="100" stroke-width="2"/><line x1="150" y1="250" x2="1050" y2="250" stroke-width="2" opacity="0.5"/><line x1="150" y1="550" x2="1050" y2="550" stroke-width="2" opacity="0.5"/><circle cx="300" cy="400" r="3" fill="white"/><circle cx="900" cy="400" r="3" fill="white"/></g></svg>');
        }

        .weekly-grid {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            position: relative;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            border-radius: 10px;
            padding: 10px;
        }

        /* Calendar with backgrounds */
        .calendar-wrapper {
            position: relative;
            min-height: 600px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 10px;
            overflow: hidden;
        }

        .calendar-wrapper.tennis {
            background: linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,0.9)),
                        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><pattern id="court2" x="0" y="0" width="100%" height="100%"><rect fill="%234a7c59" width="1200" height="400"/><rect fill="%23d2691e" y="400" width="1200" height="400"/><rect x="50" y="50" width="1100" height="700" fill="none" stroke="white" stroke-width="5"/><line x1="50" y1="400" x2="1150" y2="400" stroke="white" stroke-width="5"/><line x1="600" y1="50" x2="600" y2="750" stroke="white" stroke-width="3"/><rect x="50" y="200" width="300" height="400" fill="none" stroke="white" stroke-width="3"/><rect x="850" y="200" width="300" height="400" fill="none" stroke="white" stroke-width="3"/></pattern></defs><rect width="100%" height="100%" fill="url(%23court2)"/></svg>');
        }

        .calendar-wrapper.calcio8 {
            background: linear-gradient(rgba(255,255,255,0.88), rgba(255,255,255,0.88)),
                        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><radialGradient id="grass2"><stop offset="0%" style="stop-color:%23228b22"/><stop offset="100%" style="stop-color:%231f5f1f"/></radialGradient></defs><rect fill="url(%23grass2)" width="1200" height="800"/><g stroke="white" fill="none"><rect x="50" y="50" width="1100" height="700" stroke-width="5"/><line x1="600" y1="50" x2="600" y2="750" stroke-width="4"/><circle cx="600" cy="400" r="90" stroke-width="4"/><circle cx="600" cy="400" r="5" fill="white"/><rect x="50" y="200" width="200" height="400" stroke-width="4"/><rect x="950" y="200" width="200" height="400" stroke-width="4"/></g></svg>');
        }

        .calendar-wrapper.padel {
            background: linear-gradient(rgba(255,255,255,0.88), rgba(255,255,255,0.88)),
                        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><linearGradient id="blue2" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:%232196F3"/><stop offset="100%" style="stop-color:%231976D2"/></linearGradient></defs><rect fill="url(%23blue2)" width="1200" height="800"/><g stroke="white" fill="none"><rect x="150" y="100" width="900" height="600" stroke-width="6"/><line x1="150" y1="400" x2="1050" y2="400" stroke-width="4"/><line x1="600" y1="100" x2="600" y2="700" stroke-width="3" stroke-dasharray="10,5"/><rect x="150" y="300" width="150" height="200" stroke-width="3"/><rect x="900" y="300" width="150" height="200" stroke-width="3"/></g></svg>');
        }

        /* Weekly calendar styles */
        .time-header {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .day-header {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .day-header.today {
            background: #e3f2fd;
            color: #1e3c72;
        }

        .time-slot {
            font-size: 12px;
            padding: 5px;
            text-align: right;
            color: #666;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .hour-cell {
            border: 1px solid #e0e0e0;
            min-height: 30px;
            position: relative;
            padding: 0;
        }

        .hour-cell.half-hour {
            border-top: 1px dashed #d0d0d0;
        }

        /* Padel weekly view styles */
        .weekly-grid.padel-view {
            grid-template-columns: 80px repeat(14, 1fr);
        }

        .padel-campo-label {
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            padding: 5px;
            color: white;
            border-radius: 4px 4px 0 0;
        }

        .padel-campo-label.campo1 {
            background: #2196F3;
        }

        .padel-campo-label.campo2 {
            background: #1976D2;
        }

        .hour-cell.padel1 {
            background: rgba(33, 150, 243, 0.1);
            border-right: 2px solid #2196F3;
        }

        .hour-cell.padel2 {
            background: rgba(25, 118, 210, 0.1);
        }

        .weekly-booking {
            position: absolute;
            background: #2196F3;
            color: white;
            padding: 4px 6px;
            border-radius: 6px;
            font-size: 11px;
            overflow: hidden;
            cursor: pointer;
            left: 2px;
            right: 2px;
            z-index: 5;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .weekly-booking .booking-time {
            font-weight: bold;
            font-size: 10px;
        }

        .weekly-booking .booking-client {
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Sport-specific colors */
        .weekly-booking.sport-tennis {
            background: #FFD700; /* Giallo per tennis */
            color: #333;
        }

        .weekly-booking.sport-calcio5 {
            background: #5DADE2; /* Azzurro per calcio a 5 */
            color: white;
        }

        .weekly-booking.calcio8 {
            background: #228b22;
        }

        .weekly-booking.padel1 {
            background: #2196F3;
        }

        .weekly-booking.padel2 {
            background: #1976D2;
        }

        /* Sport selector */
        #sportSelector {
            display: none;
        }

        #sportSelector.show {
            display: block;
        }

        /* Monthly Calendar */
        .calendar-container {
            margin-top: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-btn {
            background: #2a5298;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .calendar-btn:hover {
            background: #1e3c72;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .calendar-day {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 10px;
            min-height: 120px;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .calendar-day:hover {
            border-color: #2a5298;
        }

        .calendar-day-header {
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 5px;
        }

        .calendar-day.other-month {
            opacity: 0.4;
        }

        .calendar-day.today {
            background: #e3f2fd;
            border-color: #2a5298;
        }

        /* Booking Form */
        .booking-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Bookings */
        .booking-slot {
            background: white;
            padding: 8px;
            margin-top: 5px;
            border-radius: 8px;
            font-size: 13px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .booking-slot.sport-tennis {
            background: #FFD700;
            color: #333;
        }

        .booking-slot.sport-calcio5 {
            background: #5DADE2;
            color: white;
        }

        .booking-slot .time {
            font-weight: 600;
            color: #1e3c72;
        }

        .booking-slot.sport-tennis .time,
        .booking-slot.sport-calcio5 .time {
            color: inherit;
        }

        .bookings-list {
            margin-top: 30px;
        }

        .booking-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .booking-info {
            flex: 1;
            min-width: 200px;
        }

        .booking-info h4 {
            color: #1e3c72;
            margin-bottom: 5px;
        }

        .booking-info p {
            color: #666;
            font-size: 14px;
        }

        .edit-btn {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
        }

        .edit-btn:hover {
            background: #218838;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .booking-actions {
            display: flex;
            gap: 10px;
        }

        .edit-mode-banner {
            background: #ffc107;
            color: #333;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            margin: 50px auto;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: #333;
        }

        /* Padel split view styles */
        .padel-split {
            display: flex;
            height: 80px;
            gap: 2px;
        }

        .padel-section {
            flex: 1;
            padding: 2px;
            border-radius: 4px;
        }

        .padel-section.padel1 {
            background: rgba(33, 150, 243, 0.1);
        }

        .padel-section.padel2 {
            background: rgba(25, 118, 210, 0.1);
        }

        .padel-label {
            font-size: 10px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 2px;
        }

        .padel-label.padel1 {
            color: #2196F3;
        }

        .padel-label.padel2 {
            color: #1976D2;
        }

        .padel-booking {
            font-size: 10px;
            padding: 2px;
            margin: 1px 0;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
        }

        .padel-booking.padel1 {
            background: #2196F3;
        }

        .padel-booking.padel2 {
            background: #1976D2;
        }

        /* Debug panel */
        .debug-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            z-index: 9999;
        }
        
        .sync-notice {
            background: #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sync-notice a {
            color: #0066cc;
            text-decoration: none;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .sync-notice {
                font-size: 12px;
                padding: 10px;
                flex-direction: column;
                text-align: center;
            }
            
            .debug-panel {
                bottom: 60px; /* Above mobile navigation */
                right: 5px;
                left: 5px;
                max-width: none;
            }
        }

        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
            z-index: 10000;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .tabs {
                flex-direction: column;
                width: 100%;
            }
            
            .tab {
                width: 100%;
                text-align: center;
            }
            
            .field-tabs {
                flex-direction: column;
                width: 100%;
            }
            
            .field-tab {
                width: 100%;
                justify-content: center;
            }
            
            .booking-form {
                grid-template-columns: 1fr;
            }
            
            /* Weekly calendar mobile */
            .weekly-calendar {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scroll-snap-type: x proximity;
            }
            
            .weekly-wrapper {
                min-width: 800px;
            }
            
            .weekly-grid {
                font-size: 11px;
            }
            
            .time-slot {
                font-size: 10px;
            }
            
            .hour-cell {
                min-height: 25px;
            }
            
            .weekly-booking {
                font-size: 9px;
                padding: 2px 4px;
            }
            
            .weekly-booking .booking-time {
                font-size: 8px;
            }
            
            .weekly-booking .booking-client {
                font-size: 8px;
            }
            
            .day-header {
                font-size: 11px;
                padding: 8px 5px;
            }
            
            /* Monthly calendar mobile */
            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 3px;
            }
            
            .calendar-day {
                min-height: 80px;
                padding: 5px;
                font-size: 11px;
            }
            
            .calendar-day-header {
                font-size: 10px;
            }
            
            .booking-slot {
                font-size: 10px;
                padding: 4px;
            }
            
            /* Modal mobile */
            .modal-content {
                margin: 20px;
                padding: 20px;
                max-height: 90vh;
            }
            
            /* Booking cards mobile */
            .booking-card {
                flex-direction: column;
                align-items: stretch;
            }
            
            .booking-actions {
                width: 100%;
                justify-content: stretch;
            }
            
            .booking-actions button {
                flex: 1;
            }
            
            /* Padel weekly view mobile optimization */
            .weekly-grid.padel-view {
                grid-template-columns: 60px repeat(14, 1fr);
                min-width: 1000px;
            }
            
            .padel-campo-label {
                font-size: 9px;
                padding: 3px;
            }
            
            /* Sticky time column for better scrolling */
            .time-header,
            .time-slot {
                position: sticky;
                left: 0;
                background: #f8f9fa;
                z-index: 10;
            }
            
            /* View toggle mobile */
            .view-toggle {
                flex-direction: column;
                width: 100%;
            }
            
            .view-btn {
                width: 100%;
                margin-bottom: 5px;
            }
            
            /* Calendar navigation mobile */
            .calendar-header {
                flex-direction: column;
                text-align: center;
            }
            
            .calendar-nav {
                flex-wrap: wrap;
                justify-content: center;
                margin-top: 10px;
            }
            
            .calendar-btn {
                font-size: 12px;
                padding: 6px 12px;
                margin: 2px;
            }
            
            /* Form improvements mobile */
            label {
                font-size: 14px;
            }
            
            /* Weekly scroll container improvement */
            .weekly-calendar {
                border-radius: 10px;
                position: relative;
            }
            
            .weekly-calendar::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 30px;
                background: linear-gradient(to right, transparent, rgba(255,255,255,0.8));
                pointer-events: none;
            }
            
            /* Login improvements */
            .login-container {
                padding: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }
            
            .login-box {
                padding: 20px;
                margin: 10px;
            }
            
            .calendar-day {
                min-height: 60px;
                padding: 3px;
                padding-bottom: 25px; /* Space for counter */
            }
            
            /* Calendar day mobile - show count instead of details */
            .calendar-day {
                position: relative;
            }
            
            .calendar-day .booking-slot,
            .calendar-day .padel-split {
                display: none;
            }
            
            .calendar-day[data-bookings-count]:not([data-bookings-count="0"])::after {
                content: attr(data-bookings-count);
                display: flex;
                align-items: center;
                justify-content: center;
                position: absolute;
                bottom: 5px;
                right: 5px;
                background: #007bff;
                color: white;
                border-radius: 50%;
                width: 24px;
                height: 24px;
                font-size: 12px;
                font-weight: bold;
            }
            
            .calendar-day.padel-view[data-bookings-count]:not([data-bookings-count="0"])::after {
                background: #2196F3;
            }
            
            .calendar-day.today[data-bookings-count]:not([data-bookings-count="0"])::after {
                background: #dc3545;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
        }
        
        /* Landscape mode adjustments */
        @media (max-height: 600px) and (orientation: landscape) {
            .header {
                padding: 10px;
                margin-bottom: 10px;
            }
            
            .tabs {
                margin-bottom: 15px;
            }
            
            .content-section {
                padding: 15px;
            }
            
            .weekly-wrapper,
            .calendar-wrapper {
                min-height: 400px;
            }
        }
        
        /* Touch-friendly adjustments */
        @media (hover: none) and (pointer: coarse) {
            .tab, .field-tab, .btn, .calendar-btn, .view-btn, .edit-btn, .delete-btn {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .hour-cell {
                min-height: 35px;
            }
            
            input, select {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
        
        /* Scrollable weekly view indicator */
        .scroll-indicator {
            display: none;
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: 10px;
            animation: pulse 2s infinite;
        }
        
        @media (max-width: 768px) {
            .scroll-indicator {
                display: block;
            }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        
        /* Mobile-specific calendar styles */
        .mobile-only {
            display: none;
        }
        
        @media (max-width: 768px) {
            .mobile-only {
                display: block;
            }
            
            .desktop-only {
                display: none;
            }
        }
        
        /* iOS specific fixes */
        @supports (-webkit-touch-callout: none) {
            input[type="date"],
            input[type="time"] {
                -webkit-appearance: none;
                background: white;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h2>🏐 Centro Sportivo</h2>
            <div class="form-group">
                <label for="username">Nome Utente</label>
                <select id="username">
                    <option value="">Seleziona utente</option>
                    <option value="davide">Davide</option>
                    <option value="luigi">Luigi</option>
                    <option value="matteo">Matteo</option>
                    <option value="stefano">Stefano</option>
                </select>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Inserisci password">
            </div>
            <button class="btn" onclick="login()">Accedi</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="appContainer" class="app-container">
        <div class="container">
            <div class="header">
                <div class="header-content">
                    <h1>⚽ Gestionale Centro Sportivo</h1>
                    <div class="user-info">
                        <span>Benvenuto, <strong id="currentUser"></strong></span>
                        <button onclick="logout()" class="btn logout-btn">Esci</button>
                    </div>
                </div>
            </div>

            <!-- Data sync notice -->
            <div id="syncNotice" class="sync-notice" style="background: #ffc107; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;">
                <strong>⚠️ Nota:</strong> <span id="syncStatus">I dati sono salvati localmente nel browser.</span>
                <a href="#" onclick="showSyncOptions()" style="color: #0066cc;">Configura sincronizzazione</a>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('booking')">➕ Nuova Prenotazione</div>
                <div class="tab" onclick="switchTab('calendar')">📅 Calendari per Campo</div>
                <div class="tab" onclick="switchTab('list')">📋 Lista Prenotazioni</div>
            </div>

            <!-- Booking Section -->
            <div id="bookingSection" class="content-section active">
                <h2>Nuova Prenotazione</h2>
                <div id="editModeBanner" class="edit-mode-banner" style="display: none;">
                    ⚠️ Modalità Modifica - Stai modificando una prenotazione esistente
                    <button onclick="cancelEdit()" style="margin-left: 20px; padding: 5px 15px; background: white; border: 1px solid #333; border-radius: 5px; cursor: pointer;">Annulla</button>
                </div>
                <div class="booking-form">
                    <div class="form-group">
                        <label>Campo</label>
                        <select id="field" onchange="toggleSportSelector()">
                            <option value="">Seleziona campo</option>
                            <option value="tennis">🎾 Tennis/Calcio a 5</option>
                            <option value="calcio8">⚽ Calcio a 8</option>
                            <option value="padel1">🎾 Padel 1</option>
                            <option value="padel2">🎾 Padel 2</option>
                        </select>
                    </div>
                    <div class="form-group" id="sportSelector">
                        <label>Sport</label>
                        <select id="sport">
                            <option value="tennis">🎾 Tennis</option>
                            <option value="calcio5">⚽ Calcio a 5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="date">
                    </div>
                    <div class="form-group">
                        <label>Ora Inizio</label>
                        <input type="time" id="startTime">
                    </div>
                    <div class="form-group">
                        <label>Ora Fine</label>
                        <input type="time" id="endTime">
                    </div>
                    <div class="form-group">
                        <label>Nome Cliente</label>
                        <input type="text" id="clientName" placeholder="Nome del cliente">
                    </div>
                    <div class="form-group">
                        <label>Telefono</label>
                        <input type="tel" id="phone" placeholder="Numero di telefono">
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <input type="text" id="notes" placeholder="Note aggiuntive">
                    </div>
                    <div class="form-group" id="repeatSection">
                        <label>Ripetizione</label>
                        <select id="repeatType" onchange="toggleRepeatOptions()">
                            <option value="none">Nessuna ripetizione</option>
                            <option value="daily">Ogni giorno</option>
                            <option value="weekly">Ogni settimana</option>
                            <option value="custom">Personalizzata</option>
                        </select>
                    </div>
                    <div id="repeatOptions" style="display: none;">
                        <div class="form-group">
                            <label>Ripeti per</label>
                            <input type="number" id="repeatCount" min="1" max="52" value="4" style="width: 80px;">
                            <span id="repeatUnit">volte</span>
                        </div>
                        <div id="customDays" style="display: none;">
                            <label>Giorni della settimana:</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                                <label><input type="checkbox" value="1"> Lun</label>
                                <label><input type="checkbox" value="2"> Mar</label>
                                <label><input type="checkbox" value="3"> Mer</label>
                                <label><input type="checkbox" value="4"> Gio</label>
                                <label><input type="checkbox" value="5"> Ven</label>
                                <label><input type="checkbox" value="6"> Sab</label>
                                <label><input type="checkbox" value="0"> Dom</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button id="submitBtn" class="btn" onclick="addBooking()">Aggiungi Prenotazione</button>
                    </div>
                </div>
            </div>

            <!-- Calendar Section -->
            <div id="calendarSection" class="content-section">
                <h2>Calendari per Campo</h2>
                
                <div class="field-tabs">
                    <div class="field-tab active" onclick="switchFieldCalendar('tennis')">
                        <span style="font-size: 24px;">🎾</span>
                        <span>Tennis/Calcio a 5</span>
                    </div>
                    <div class="field-tab" onclick="switchFieldCalendar('calcio8')">
                        <span style="font-size: 24px;">⚽</span>
                        <span>Calcio a 8</span>
                    </div>
                    <div class="field-tab" onclick="switchFieldCalendar('padel')">
                        <span style="font-size: 24px;">🏸</span>
                        <span>Padel 1 & 2</span>
                    </div>
                </div>

                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('weekly')">Vista Settimanale</button>
                    <button class="view-btn" onclick="switchView('monthly')">Vista Mensile</button>
                </div>

                <!-- Weekly View -->
                <div id="weeklyView" class="calendar-view">
                    <div class="calendar-header">
                        <h3 id="currentWeek"></h3>
                        <div class="calendar-nav">
                            <button class="calendar-btn" onclick="previousWeek()">← Settimana Prec.</button>
                            <button class="calendar-btn" onclick="currentWeek()">Questa Settimana</button>
                            <button class="calendar-btn" onclick="nextWeek()">Settimana Succ. →</button>
                        </div>
                    </div>
                    <div class="weekly-calendar">
                        <div class="weekly-wrapper" id="weeklyWrapper">
                            <div class="weekly-grid" id="weeklyGrid"></div>
                        </div>
                        <div class="scroll-indicator">
                            ← Scorri per vedere tutti i giorni →<br>
                            <span class="mobile-only" style="font-size: 11px;">👆 Tocca una prenotazione per i dettagli</span>
                        </div>
                    </div>
                </div>

                <!-- Monthly View -->
                <div id="monthlyView" class="calendar-view" style="display: none;">
                    <div class="calendar-container">
                        <div class="calendar-wrapper" id="calendarWrapper">
                            <div class="calendar-header">
                                <h3 id="currentMonth"></h3>
                                <div class="calendar-nav">
                                    <button class="calendar-btn" onclick="previousMonth()">← Precedente</button>
                                    <button class="calendar-btn" onclick="currentMonth()">Questo Mese</button>
                                    <button class="calendar-btn" onclick="nextMonth()">Successivo →</button>
                                </div>
                            </div>
                            <div class="calendar-grid" id="calendarGrid"></div>
                            <div class="scroll-indicator mobile-only" style="margin-top: 15px; text-align: center;">
                                👆 Tocca un giorno per vedere i dettagli<br>
                                ← Swipe per cambiare mese →
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- List Section -->
            <div id="listSection" class="content-section">
                <h2>Lista Prenotazioni</h2>
                <div class="form-group">
                    <label>Filtra per campo:</label>
                    <select id="filterField" onchange="filterBookings()">
                        <option value="">Tutti i campi</option>
                        <option value="tennis">🎾 Tennis/Calcio a 5</option>
                        <option value="calcio8">⚽ Calcio a 8</option>
                        <option value="padel1">🏸 Padel 1</option>
                        <option value="padel2">🏸 Padel 2</option>
                    </select>
                </div>
                <div class="form-group mobile-only">
                    <p style="font-size: 12px; color: #666; text-align: center;">
                        📱 Tocca una prenotazione per vedere i dettagli
                    </p>
                </div>
                <div class="form-group">
                    <button class="btn" onclick="clearAllData()" style="background: #dc3545; width: auto; padding: 10px 20px;">Cancella Tutti i Dati</button>
                </div>
                <div id="bookingsList" class="bookings-list"></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="dayModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeDayModal()">&times;</span>
            <h3 id="modalDate"></h3>
            <div id="modalBookings"></div>
        </div>
    </div>

    <!-- Sync Options Modal -->
    <div id="syncModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSyncModal()">&times;</span>
            <h3>🔄 Configurazione Google Sheets</h3>
            
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4>📋 Stato Attuale</h4>
                <p id="configStatus" style="margin: 10px 0; font-weight: bold;"></p>
            </div>
            
            <div style="background: #f0f4c3; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4>⚙️ Come Configurare</h4>
                <ol style="margin: 10px 0; padding-left: 20px;">
                    <li>Segui le istruzioni sopra per creare il Google Sheet e lo script</li>
                    <li>Copia l'URL della Web App (es: https://script.google.com/macros/s/AKfyc.../exec)</li>
                    <li>Modifica il file HTML:</li>
                    <ul>
                        <li>Trova la riga: <code>const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwu_qPZelcejB0L5Iie2KaQI1SC9eu1gyW9JpJ17XBGcQxtJVNoN7wNRbkIjU0b6lir/exec';</code></li>
                        <li>Sostituisci <code>YOUR_GOOGLE_SCRIPT_URL</code> con il tuo URL</li>
                    </ul>
                    <li>Carica il file aggiornato su GitHub</li>
                    <li>Ricarica la pagina - la sincronizzazione sarà attiva!</li>
                </ol>
            </div>
            
            <div style="background: #e1f5fe; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4>📊 Link Utili</h4>
                <p><a href="https://sheets.google.com" target="_blank" style="color: #0066cc;">➜ Google Sheets</a></p>
                <p><a href="https://script.google.com" target="_blank" style="color: #0066cc;">➜ Google Apps Script</a></p>
                <p><a href="https://developers.google.com/apps-script/guides/web" target="_blank" style="color: #0066cc;">➜ Documentazione Web Apps</a></p>
            </div>
            
            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4>💾 Backup Manuale</h4>
                <p>Mentre configuri Google Sheets, puoi usare il backup manuale:</p>
                <button onclick="exportData()" class="btn" style="margin: 5px;">📥 Esporta Dati</button>
                <button onclick="document.getElementById('importFile').click()" class="btn" style="margin: 5px;">📤 Importa Dati</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel" style="display: none;">
        <strong>DEBUG INFO:</strong>
        <div id="debugInfo"></div>
    </div>

    <script>
        // Enable debug mode - SET TO false IN PRODUCTION
        const DEBUG = false;

        // App State
        let currentUser = null;
        let bookings = [];
        let displayedMonth = new Date();
        let displayedWeek = new Date();
        let selectedField = 'tennis';
        let currentView = 'weekly';
        let editMode = false;
        let editingBookingId = null;

        // Users data
        const users = {
            davide: { password: 'davide123', name: 'Davide' },
            luigi: { password: 'luigi123', name: 'Luigi' },
            matteo: { password: 'matteo123', name: 'Matteo' },
            stefano: { password: 'stefano123', name: 'Stefano' }
        };

        // Field configuration
        const fieldConfig = {
            tennis: { name: 'Tennis/Calcio a 5', icon: '🎾' },
            calcio8: { name: 'Calcio a 8', icon: '⚽' },
            padel1: { name: 'Padel 1', icon: '🏸' },
            padel2: { name: 'Padel 2', icon: '🏸' },
            padel: { name: 'Padel 1 & 2', icon: '🏸' }
        };

        // Debug function
        function debug(message, data = null) {
            if (DEBUG) {
                console.log(`[DEBUG] ${message}`, data);
                const debugPanel = document.getElementById('debugPanel');
                const debugInfo = document.getElementById('debugInfo');
                if (debugPanel && debugInfo) {
                    debugPanel.style.display = 'block';
                    debugInfo.innerHTML = `${message}<br>${data ? JSON.stringify(data, null, 2) : ''}`;
                    setTimeout(() => {
                        debugPanel.style.display = 'none';
                    }, 3000);
                }
            }
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Google Sheets configuration
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwu_qPZelcejB0L5Iie2KaQI1SC9eu1gyW9JpJ17XBGcQxtJVNoN7wNRbkIjU0b6lir/exec'; // Sostituisci con l'URL della tua Web App
        let syncEnabled = false;
        let syncInterval = null;
        
        // Check if Google Sheets is configured
        function checkGoogleSheetsConfig() {
            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_URL') {
                console.log('Google Sheets non configurato. Usa localStorage.');
                return false;
            }
            return true;
        }
        
      // Sync with Google Sheets
async function syncWithGoogleSheets() {
    if (!checkGoogleSheetsConfig()) return;
    
    try {
        // Usa JSONP per evitare problemi CORS
        const script = document.createElement('script');
        const callbackName = 'handleGoogleSheetsData_' + Date.now();
        
        window[callbackName] = function(result) {
            if (result.success) {
                bookings = result.data.map(booking => {
                    // Ensure date is in YYYY-MM-DD format
                    let formattedDate = booking.date;
                    
                    // If date contains '/', convert to YYYY-MM-DD
                    if (formattedDate && formattedDate.includes('/')) {
                        const parts = formattedDate.split('/');
                        if (parts.length === 3) {
                            // Assume DD/MM/YYYY format
                            formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                        }
                    }
                    
                    return {
                        ...booking,
                        id: parseInt(booking.id) || booking.id,
                        date: formattedDate,
                        startTime: booking.startTime || '',
                        endTime: booking.endTime || ''
                    };
                });
                
                updateAllViews();
                debug('Data synced from Google Sheets', { count: bookings.length });
                
                // Rimuovi il messaggio di errore se presente
                const header = document.querySelector('.header');
                const errorMsg = header.querySelector('.error-banner');
                if (errorMsg) {
                    errorMsg.remove();
                }
            }
            
            // Cleanup
            delete window[callbackName];
            document.body.removeChild(script);
        };
        
        script.src = `${GOOGLE_SCRIPT_URL}?callback=${callbackName}`;
        document.body.appendChild(script);
        
    } catch (error) {
        console.error('Sync error:', error);
        showError('Errore sincronizzazione con Google Sheets');
    }
}
            
            console.log('Bookings synced:', bookings.length);
            console.log('Sample booking:', bookings[0]);
            
            updateAllViews();
            debug('Data synced from Google Sheets', { count: bookings.length });
        }
    } catch (error) {
        console.error('Sync error:', error);
        showError('Errore sincronizzazione con Google Sheets');
    }
}
        
        // Save booking to Google Sheets
        async function saveToGoogleSheets(booking, action = 'add') {
            if (!checkGoogleSheetsConfig()) return;
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        booking: booking
                    })
                });
                
                debug(`Booking ${action} to Google Sheets`, booking);
                
                // Sync after save
                setTimeout(() => syncWithGoogleSheets(), 1000);
            } catch (error) {
                console.error('Save error:', error);
                showError('Errore salvataggio su Google Sheets');
            }
        }
        
        // Delete booking from Google Sheets
        async function deleteFromGoogleSheets(id) {
            if (!checkGoogleSheetsConfig()) return;
            
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'delete',
                        id: id
                    })
                });
                
                debug('Booking deleted from Google Sheets', { id });
                
                // Sync after delete
                setTimeout(() => syncWithGoogleSheets(), 1000);
            } catch (error) {
                console.error('Delete error:', error);
                showError('Errore eliminazione da Google Sheets');
            }
        }
        
        // Clear all data from Google Sheets
        async function clearGoogleSheets() {
            if (!checkGoogleSheetsConfig()) return;
            
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'clear'
                    })
                });
                
                debug('All data cleared from Google Sheets');
                
                // Sync after clear
                setTimeout(() => syncWithGoogleSheets(), 1000);
            } catch (error) {
                console.error('Clear error:', error);
                showError('Errore cancellazione dati da Google Sheets');
            }
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #dc3545;
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                animation: slideIn 0.3s ease;
                z-index: 10000;
            `;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }
        
        // Modified save data function
        function saveData() {
            try {
                localStorage.setItem('sportsCenterBookings', JSON.stringify(bookings));
                localStorage.setItem('sportsCenterUser', currentUser);
                debug('Data saved to localStorage', { bookingsCount: bookings.length });
            } catch (e) {
                console.error('Error saving data:', e);
            }
        }
        
        // Modified load data function
        function loadData() {
            if (checkGoogleSheetsConfig()) {
                // If Google Sheets is configured, sync from there
                syncWithGoogleSheets();
                
                // Start auto-sync
                if (!syncInterval) {
                    syncInterval = setInterval(syncWithGoogleSheets, 10000); // Sync every 10 seconds
                }
                syncEnabled = true;
            } else {
                // Otherwise use localStorage
                try {
                    const savedBookings = localStorage.getItem('sportsCenterBookings');
                    if (savedBookings) {
                        bookings = JSON.parse(savedBookings);
                        debug('Data loaded from localStorage', { bookingsCount: bookings.length });
                    }
                } catch (e) {
                    console.error('Error loading data:', e);
                    bookings = [];
                }
            }
        }

        function clearAllData() {
            if (confirm('Sei sicuro di voler cancellare TUTTI i dati? Questa azione non può essere annullata.')) {
                bookings = [];
                localStorage.removeItem('sportsCenterBookings');
                
                // Clear Google Sheets if configured
                if (checkGoogleSheetsConfig()) {
                    clearGoogleSheets();
                }
                
                updateAllViews();
                showSuccess('Tutti i dati sono stati cancellati!');
            }
        }

        // Login function
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('currentUser').textContent = users[currentUser].name;
                
                // Set today's date
                document.getElementById('date').valueAsDate = new Date();
                
                // Hide sport selector initially
                document.getElementById('sportSelector').classList.remove('show');
                
                // Load saved data
                loadData();
                
                // Update sync status
                if (checkGoogleSheetsConfig() && syncEnabled) {
                    document.getElementById('syncStatus').textContent = 'Sincronizzazione con Google Sheets attiva ✅';
                    document.getElementById('syncNotice').style.background = '#d4edda';
                }
                
                // Initialize backgrounds
                const monthlyWrapper = document.getElementById('calendarWrapper');
                if (monthlyWrapper) {
                    monthlyWrapper.className = 'calendar-wrapper tennis';
                }
                const weeklyWrapper = document.getElementById('weeklyWrapper');
                if (weeklyWrapper) {
                    weeklyWrapper.className = 'weekly-wrapper tennis';
                }
                
                updateAllViews();
                showSuccess(`Benvenuto ${users[currentUser].name}!`);
            } else {
                alert('Credenziali non valide!');
            }
        }

        function logout() {
            currentUser = null;
            cleanup();
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Update all views
        function updateAllViews() {
            updateWeeklyCalendar();
            updateMonthlyCalendar();
            updateBookingsList();
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            if (tabName === 'booking') {
                document.getElementById('bookingSection').classList.add('active');
            } else if (tabName === 'calendar') {
                document.getElementById('calendarSection').classList.add('active');
                updateAllViews();
            } else if (tabName === 'list') {
                document.getElementById('listSection').classList.add('active');
                updateBookingsList();
            }
        }

        // Switch view
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (view === 'weekly') {
                document.getElementById('weeklyView').style.display = 'block';
                document.getElementById('monthlyView').style.display = 'none';
                updateWeeklyCalendar();
            } else {
                document.getElementById('weeklyView').style.display = 'none';
                document.getElementById('monthlyView').style.display = 'block';
                updateMonthlyCalendar();
            }
        }

        // Switch field
        function switchFieldCalendar(field) {
            selectedField = field;
            document.querySelectorAll('.field-tab').forEach(tab => tab.classList.remove('active'));
            event.target.closest('.field-tab').classList.add('active');
            
            // Update calendar backgrounds
            const monthlyWrapper = document.getElementById('calendarWrapper');
            if (monthlyWrapper) {
                monthlyWrapper.className = 'calendar-wrapper ' + field;
            }
            
            const weeklyWrapper = document.getElementById('weeklyWrapper');
            if (weeklyWrapper) {
                weeklyWrapper.className = 'weekly-wrapper ' + field;
            }
            
            updateAllViews();
            debug('Switched field', { selectedField: field });
        }

        // Toggle sport selector
        function toggleSportSelector() {
            const field = document.getElementById('field').value;
            const sportSelector = document.getElementById('sportSelector');
            
            if (field === 'tennis') {
                sportSelector.classList.add('show');
            } else {
                sportSelector.classList.remove('show');
            }
        }

        // Edit booking
        function editBooking(id) {
            const booking = bookings.find(b => b.id === id);
            if (!booking) return;
            
            editMode = true;
            editingBookingId = id;
            
            // Switch to booking tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.tab').classList.add('active');
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('bookingSection').classList.add('active');
            
            // Show edit mode banner
            document.getElementById('editModeBanner').style.display = 'block';
            document.getElementById('submitBtn').textContent = 'Salva Modifiche';
            
            // Hide repeat section in edit mode
            document.getElementById('repeatSection').style.display = 'none';
            document.getElementById('repeatOptions').style.display = 'none';
            
            // Populate form with booking data
            document.getElementById('field').value = booking.field;
            toggleSportSelector();
            
            if (booking.sport) {
                document.getElementById('sport').value = booking.sport;
            }
            
            document.getElementById('date').value = booking.date;
            document.getElementById('startTime').value = booking.startTime;
            document.getElementById('endTime').value = booking.endTime;
            document.getElementById('clientName').value = booking.clientName;
            document.getElementById('phone').value = booking.phone || '';
            document.getElementById('notes').value = booking.notes || '';
            
            // Close modal if open
            closeDayModal();
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            debug('Edit mode activated', { bookingId: id });
        }

        // Cancel edit
        function cancelEdit() {
            editMode = false;
            editingBookingId = null;
            
            document.getElementById('editModeBanner').style.display = 'none';
            document.getElementById('submitBtn').textContent = 'Aggiungi Prenotazione';
            document.getElementById('repeatSection').style.display = 'block';
            
            // Clear form
            clearForm();
            
            debug('Edit mode cancelled');
        }

        // Clear form
        function clearForm() {
            document.getElementById('field').value = '';
            document.getElementById('sport').value = 'tennis';
            document.getElementById('sportSelector').classList.remove('show');
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
            document.getElementById('clientName').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('repeatType').value = 'none';
            document.getElementById('repeatOptions').style.display = 'none';
        }

        // Toggle repeat options
        function toggleRepeatOptions() {
            const repeatType = document.getElementById('repeatType').value;
            const repeatOptions = document.getElementById('repeatOptions');
            const customDays = document.getElementById('customDays');
            const repeatUnit = document.getElementById('repeatUnit');
            
            if (repeatType === 'none') {
                repeatOptions.style.display = 'none';
            } else {
                repeatOptions.style.display = 'block';
                
                if (repeatType === 'daily') {
                    customDays.style.display = 'none';
                    repeatUnit.textContent = 'giorni';
                } else if (repeatType === 'weekly') {
                    customDays.style.display = 'none';
                    repeatUnit.textContent = 'settimane';
                } else if (repeatType === 'custom') {
                    customDays.style.display = 'block';
                    repeatUnit.textContent = 'settimane';
                }
            }
        }

        // Check booking overlap
        function checkBookingOverlap(field, date, startTime, endTime, excludeId = null) {
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            
            return bookings.some(booking => {
                if (excludeId && booking.id === excludeId) return false;
                if (booking.field !== field || booking.date !== date) return false;
                
                const bookingStart = timeToMinutes(booking.startTime);
                const bookingEnd = timeToMinutes(booking.endTime);
                
                // Check overlap
                return (startMinutes < bookingEnd && endMinutes > bookingStart);
            });
        }
        
        // Add or update booking
        function addBooking() {
            const field = document.getElementById('field').value;
            const date = document.getElementById('date').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const clientName = document.getElementById('clientName').value;
            const repeatType = document.getElementById('repeatType').value;
            
            if (!field || !date || !startTime || !endTime || !clientName) {
                alert('Compila tutti i campi obbligatori!');
                return;
            }
            
            // Get sport if tennis field is selected
            let sport = null;
            if (field === 'tennis') {
                sport = document.getElementById('sport').value;
            }
            
            if (editMode) {
                // Check for overlaps excluding current booking
                if (checkBookingOverlap(field, date, startTime, endTime, editingBookingId)) {
                    alert('Attenzione: Esiste già una prenotazione in questo orario!');
                    return;
                }
                
                // Update existing booking
                const bookingIndex = bookings.findIndex(b => b.id === editingBookingId);
                if (bookingIndex !== -1) {
                    bookings[bookingIndex] = {
                        ...bookings[bookingIndex],
                        field: field,
                        sport: sport,
                        date: date,
                        startTime: startTime,
                        endTime: endTime,
                        clientName: clientName,
                        phone: document.getElementById('phone').value,
                        notes: document.getElementById('notes').value,
                        modifiedBy: users[currentUser].name,
                        modifiedAt: new Date().toISOString()
                    };
                    
                    saveData();
                    
                    // Save to Google Sheets if configured
                    if (checkGoogleSheetsConfig()) {
                        saveToGoogleSheets(bookings[bookingIndex], 'update');
                    }
                    
                    showSuccess('Prenotazione modificata con successo!');
                    debug('Booking updated', bookings[bookingIndex]);
                    
                    // Exit edit mode
                    cancelEdit();
                    updateAllViews();
                }
            } else {
                // Add new booking(s)
                const baseBooking = {
                    field: field,
                    sport: sport,
                    startTime: startTime,
                    endTime: endTime,
                    clientName: clientName,
                    phone: document.getElementById('phone').value,
                    notes: document.getElementById('notes').value,
                    createdBy: users[currentUser].name
                };
                
                // Create bookings based on repeat settings
                const bookingsToAdd = [];
                const startDate = new Date(date + 'T00:00:00');
                
                if (repeatType === 'none') {
                    // Check for overlaps
                    if (checkBookingOverlap(field, date, startTime, endTime)) {
                        alert('Attenzione: Esiste già una prenotazione in questo orario!');
                        return;
                    }
                    
                    bookingsToAdd.push({
                        ...baseBooking,
                        id: Date.now(),
                        date: date
                    });
                } else if (repeatType === 'daily') {
                    const repeatCount = parseInt(document.getElementById('repeatCount').value) || 1;
                    let overlaps = [];
                    
                    for (let i = 0; i < repeatCount; i++) {
                        const currentDate = new Date(startDate);
                        currentDate.setDate(startDate.getDate() + i);
                        const currentDateStr = formatDate(currentDate);
                        
                        if (checkBookingOverlap(field, currentDateStr, startTime, endTime)) {
                            overlaps.push(currentDateStr);
                        } else {
                            bookingsToAdd.push({
                                ...baseBooking,
                                id: Date.now() + i,
                                date: currentDateStr
                            });
                        }
                    }
                    
                    if (overlaps.length > 0) {
                        alert(`Attenzione: Trovate sovrapposizioni nelle seguenti date:\n${overlaps.join('\n')}\n\nLe prenotazioni per queste date non sono state create.`);
                    }
                } else if (repeatType === 'weekly') {
                    const repeatCount = parseInt(document.getElementById('repeatCount').value) || 1;
                    for (let i = 0; i < repeatCount; i++) {
                        const currentDate = new Date(startDate);
                        currentDate.setDate(startDate.getDate() + (i * 7));
                        bookingsToAdd.push({
                            ...baseBooking,
                            id: Date.now() + i,
                            date: formatDate(currentDate)
                        });
                    }
                } else if (repeatType === 'custom') {
                    const repeatCount = parseInt(document.getElementById('repeatCount').value) || 1;
                    const selectedDays = [];
                    document.querySelectorAll('#customDays input[type="checkbox"]:checked').forEach(cb => {
                        selectedDays.push(parseInt(cb.value));
                    });
                    
                    if (selectedDays.length === 0) {
                        alert('Seleziona almeno un giorno della settimana!');
                        return;
                    }
                    
                    let addedCount = 0;
                    let currentDate = new Date(startDate);
                    let dayCounter = 0;
                    
                    while (addedCount < repeatCount * selectedDays.length && dayCounter < 365) {
                        const dayOfWeek = currentDate.getDay();
                        if (selectedDays.includes(dayOfWeek)) {
                            bookingsToAdd.push({
                                ...baseBooking,
                                id: Date.now() + addedCount,
                                date: formatDate(currentDate)
                            });
                            addedCount++;
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                        dayCounter++;
                    }
                }
                
                // Add all bookings
                bookingsToAdd.forEach(booking => {
                    bookings.push(booking);
                    
                    // Save each booking to Google Sheets if configured
                    if (checkGoogleSheetsConfig()) {
                        saveToGoogleSheets(booking, 'add');
                    }
                });
                
                // Save data locally
                saveData();
                
                const message = bookingsToAdd.length > 1 
                    ? `${bookingsToAdd.length} prenotazioni aggiunte con successo!` 
                    : 'Prenotazione aggiunta con successo!';
                
                showSuccess(message);
                debug('Bookings added', bookingsToAdd);
                
                // Clear form
                clearForm();
                
                // Update all views
                updateAllViews();
            }
        }

        // Helper function to convert time to minutes
        function timeToMinutes(time) {
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // Weekly calendar with half-hour slots
        function updateWeeklyCalendar() {
            const startOfWeek = getStartOfWeek(displayedWeek);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            
            const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
            const fieldInfo = fieldConfig[selectedField];
            
            // Shorter title for mobile
            const isMobile = window.innerWidth <= 768;
            const weekTitle = isMobile 
                ? `${fieldInfo.icon} ${startOfWeek.getDate()}/${startOfWeek.getMonth() + 1} - ${endOfWeek.getDate()}/${endOfWeek.getMonth() + 1}`
                : `${fieldInfo.icon} ${fieldInfo.name} - ${startOfWeek.getDate()} ${monthNames[startOfWeek.getMonth()]} - ${endOfWeek.getDate()} ${monthNames[endOfWeek.getMonth()]} ${endOfWeek.getFullYear()}`;
            
            document.getElementById('currentWeek').textContent = weekTitle;
            
            const grid = document.getElementById('weeklyGrid');
            grid.innerHTML = '';
            
            if (selectedField === 'padel') {
                // Padel view with split columns
                grid.className = 'weekly-grid padel-view';
                
                // Time header
                grid.innerHTML = '<div class="time-header">Orario</div>';
                
                // Day headers for padel (full width for each day)
                const days = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
                for (let i = 0; i < 7; i++) {
                    const day = new Date(startOfWeek);
                    day.setDate(startOfWeek.getDate() + i);
                    const isToday = day.toDateString() === new Date().toDateString();
                    grid.innerHTML += `<div class="day-header ${isToday ? 'today' : ''}" style="grid-column: span 2;">${days[i]} ${day.getDate()}</div>`;
                }
                
                // Add campo labels row
                grid.innerHTML += '<div></div>'; // Empty cell for time column
                for (let i = 0; i < 7; i++) {
                    grid.innerHTML += `
                        <div class="padel-campo-label campo1">C1</div>
                        <div class="padel-campo-label campo2">C2</div>
                    `;
                }
                
                // Time slots for padel with half hours
                for (let hour = 7; hour <= 23; hour++) {
                    for (let half = 0; half < 2; half++) {
                        const time = half === 0 ? `${hour}:00` : `${hour}:30`;
                        const isHalfHour = half === 1;
                        grid.innerHTML += `<div class="time-slot">${time}</div>`;
                        
                        for (let day = 0; day < 7; day++) {
                            const currentDay = new Date(startOfWeek);
                            currentDay.setDate(startOfWeek.getDate() + day);
                            const dateStr = formatDate(currentDay);
                            
                            // Campo 1 cell
                            grid.innerHTML += `<div class="hour-cell padel1 ${isHalfHour ? 'half-hour' : ''}" data-hour="${hour}" data-minutes="${half * 30}" data-day="${day}" data-date="${dateStr}" data-campo="padel1"></div>`;
                            
                            // Campo 2 cell
                            grid.innerHTML += `<div class="hour-cell padel2 ${isHalfHour ? 'half-hour' : ''}" data-hour="${hour}" data-minutes="${half * 30}" data-day="${day}" data-date="${dateStr}" data-campo="padel2"></div>`;
                        }
                    }
                }
                
                // Add bookings for both padel fields
                const weekBookings = bookings.filter(b => {
                    const bookingDate = new Date(b.date + 'T00:00:00');
                    return (b.field === 'padel1' || b.field === 'padel2') && 
                           bookingDate >= startOfWeek && bookingDate <= endOfWeek;
                });
                
                debug('Padel week bookings', { count: weekBookings.length, bookings: weekBookings });
                
                weekBookings.forEach(booking => {
                    addBookingToWeeklyPadel(booking, startOfWeek);
                });
                
            } else {
                // Normal view for other fields
                grid.className = 'weekly-grid';
                
                // Headers
                grid.innerHTML = '<div class="time-header">Orario</div>';
                const days = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
                for (let i = 0; i < 7; i++) {
                    const day = new Date(startOfWeek);
                    day.setDate(startOfWeek.getDate() + i);
                    const isToday = day.toDateString() === new Date().toDateString();
                    grid.innerHTML += `<div class="day-header ${isToday ? 'today' : ''}">${days[i]}<br>${day.getDate()}</div>`;
                }
                
                // Time slots and cells with half hours
                for (let hour = 7; hour <= 23; hour++) {
                    for (let half = 0; half < 2; half++) {
                        const time = half === 0 ? `${hour}:00` : `${hour}:30`;
                        const isHalfHour = half === 1;
                        grid.innerHTML += `<div class="time-slot">${time}</div>`;
                        
                        for (let day = 0; day < 7; day++) {
                            const currentDay = new Date(startOfWeek);
                            currentDay.setDate(startOfWeek.getDate() + day);
                            const dateStr = formatDate(currentDay);
                            grid.innerHTML += `<div class="hour-cell ${isHalfHour ? 'half-hour' : ''}" data-hour="${hour}" data-minutes="${half * 30}" data-day="${day}" data-date="${dateStr}"></div>`;
                        }
                    }
                }
                
                // Add bookings for tennis/calcio8
                const weekBookings = bookings.filter(b => {
                    const bookingDate = new Date(b.date + 'T00:00:00');
                    return b.field === selectedField && 
                           bookingDate >= startOfWeek && bookingDate <= endOfWeek;
                });
                
                debug('Week bookings', { field: selectedField, count: weekBookings.length, bookings: weekBookings });
                
                weekBookings.forEach(booking => {
                    addBookingToWeekly(booking, startOfWeek);
                });
                
                // Auto-scroll to today on mobile
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        const todayElement = document.querySelector('.day-header.today');
                        if (todayElement) {
                            const calendar = document.querySelector('.weekly-calendar');
                            const scrollLeft = todayElement.offsetLeft - calendar.offsetWidth / 2 + todayElement.offsetWidth / 2;
                            calendar.scrollLeft = Math.max(0, scrollLeft);
                        }
                    }, 100);
                }
            }
        }

        // Add booking to weekly calendar for tennis/calcio8
        function addBookingToWeekly(booking, startOfWeek) {
            const bookingDate = new Date(booking.date + 'T00:00:00');
            const dayIndex = (bookingDate.getDay() + 6) % 7; // Convert to Mon=0 index
            
            const startMinutes = timeToMinutes(booking.startTime);
            const endMinutes = timeToMinutes(booking.endTime);
            const duration = endMinutes - startMinutes;
            
            const startHour = Math.floor(startMinutes / 60);
            const startMinuteInHour = startMinutes % 60;
            const cellStartMinutes = Math.floor(startMinuteInHour / 30) * 30; // 0 or 30
            
            // Find the starting cell
            const cells = document.querySelectorAll('.hour-cell');
            let targetCell = null;
            
            cells.forEach(cell => {
                if (cell.dataset.date === booking.date && 
                    parseInt(cell.dataset.hour) === startHour &&
                    parseInt(cell.dataset.minutes) === cellStartMinutes) {
                    targetCell = cell;
                }
            });
            
            if (targetCell) {
                const bookingEl = document.createElement('div');
                // Apply sport-specific class for tennis field
                if (booking.field === 'tennis' && booking.sport) {
                    bookingEl.className = `weekly-booking sport-${booking.sport}`;
                } else {
                    bookingEl.className = `weekly-booking ${booking.field}`;
                }
                
                // Calculate position and height
                const cellHeight = 30; // Standard cell height
                const topOffset = (startMinuteInHour - cellStartMinutes) / 30 * cellHeight;
                const height = (duration / 30) * cellHeight;
                
                bookingEl.style.top = `${topOffset}px`;
                bookingEl.style.height = `${Math.max(20, height - 4)}px`; // Min height 20px
                
                bookingEl.innerHTML = `
                    <div class="booking-time">${booking.startTime} - ${booking.endTime}</div>
                    <div class="booking-client">${booking.clientName}</div>
                `;
                bookingEl.onclick = () => showDayDetails(bookingDate);
                bookingEl.title = `${booking.clientName}\n${booking.startTime} - ${booking.endTime}${booking.notes ? '\n' + booking.notes : ''}`;
                
                targetCell.appendChild(bookingEl);
            } else {
                debug('Cell not found for booking', { date: booking.date, hour: startHour, minutes: cellStartMinutes });
            }
        }

        function addBookingToWeeklyPadel(booking, startOfWeek) {
            const bookingDate = new Date(booking.date + 'T00:00:00');
            const dayIndex = (bookingDate.getDay() + 6) % 7;
            
            const startMinutes = timeToMinutes(booking.startTime);
            const endMinutes = timeToMinutes(booking.endTime);
            const duration = endMinutes - startMinutes;
            
            const startHour = Math.floor(startMinutes / 60);
            const startMinuteInHour = startMinutes % 60;
            const cellStartMinutes = Math.floor(startMinuteInHour / 30) * 30; // 0 or 30
            
            const cells = document.querySelectorAll('.hour-cell');
            let targetCell = null;
            
            cells.forEach(cell => {
                if (cell.dataset.date === booking.date && 
                    parseInt(cell.dataset.hour) === startHour &&
                    parseInt(cell.dataset.minutes) === cellStartMinutes &&
                    cell.dataset.campo === booking.field) {
                    targetCell = cell;
                }
            });
            
            if (targetCell) {
                const bookingEl = document.createElement('div');
                bookingEl.className = `weekly-booking ${booking.field}`;
                
                // Calculate position and height
                const cellHeight = 30; // Standard cell height
                const topOffset = (startMinuteInHour - cellStartMinutes) / 30 * cellHeight;
                const height = (duration / 30) * cellHeight;
                
                bookingEl.style.top = `${topOffset}px`;
                bookingEl.style.height = `${Math.max(20, height - 4)}px`; // Min height 20px
                
                bookingEl.innerHTML = `
                    <div class="booking-time">${booking.startTime} - ${booking.endTime}</div>
                    <div class="booking-client">${booking.clientName}</div>
                `;
                bookingEl.onclick = () => showDayDetails(bookingDate);
                bookingEl.title = `${booking.clientName}\n${booking.startTime} - ${booking.endTime}${booking.notes ? '\n' + booking.notes : ''}`;
                
                targetCell.appendChild(bookingEl);
            }
        }

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function previousWeek() {
            displayedWeek.setDate(displayedWeek.getDate() - 7);
            updateWeeklyCalendar();
        }

        function nextWeek() {
            displayedWeek.setDate(displayedWeek.getDate() + 7);
            updateWeeklyCalendar();
        }

        function currentWeek() {
            displayedWeek = new Date();
            updateWeeklyCalendar();
        }

        // Monthly calendar
        function updateMonthlyCalendar() {
            const year = displayedMonth.getFullYear();
            const month = displayedMonth.getMonth();
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                               'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            const fieldInfo = fieldConfig[selectedField];
            
            document.getElementById('currentMonth').textContent = 
                `${fieldInfo.icon} ${fieldInfo.name} - ${monthNames[month]} ${year}`;
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Day headers
            const dayHeaders = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                header.style.textAlign = 'center';
                header.style.fontWeight = 'bold';
                grid.appendChild(header);
            });
            
            // Calendar days
            const firstDay = new Date(year, month, 1).getDay();
            const startDay = firstDay === 0 ? 6 : firstDay - 1;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Empty cells
            for (let i = 0; i < startDay; i++) {
                grid.appendChild(createEmptyDay());
            }
            
            // Month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = createCalendarDay(year, month, day);
                grid.appendChild(dayDiv);
            }
        }

        function createEmptyDay() {
            const div = document.createElement('div');
            div.className = 'calendar-day other-month';
            return div;
        }

        function createCalendarDay(year, month, day) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            
            const date = new Date(year, month, day);
            const dateStr = formatDate(date);
            const today = new Date();
            
            if (date.toDateString() === today.toDateString()) {
                dayDiv.classList.add('today');
            }
            
            // Count bookings for mobile view
            let bookingsCount = 0;
            
            // Special handling for padel view
            if (selectedField === 'padel') {
                dayDiv.classList.add('padel-view');
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-header';
                dayNumber.textContent = day;
                dayDiv.appendChild(dayNumber);
                
                // Create split view for padel - VERTICAL split
                const padelSplit = document.createElement('div');
                padelSplit.className = 'padel-split';
                
                // Padel 1 section (left)
                const padel1Section = document.createElement('div');
                padel1Section.className = 'padel-section padel1';
                const padel1Label = document.createElement('div');
                padel1Label.className = 'padel-label padel1';
                padel1Label.textContent = 'Campo 1';
                padel1Section.appendChild(padel1Label);
                
                const padel1Bookings = bookings.filter(b => b.date === dateStr && b.field === 'padel1');
                bookingsCount += padel1Bookings.length;
                padel1Bookings.slice(0, 2).forEach(booking => {
                    const bookingDiv = document.createElement('div');
                    bookingDiv.className = 'padel-booking padel1';
                    bookingDiv.textContent = `${booking.startTime}`;
                    bookingDiv.title = booking.clientName;
                    padel1Section.appendChild(bookingDiv);
                });
                
                // Padel 2 section (right)
                const padel2Section = document.createElement('div');
                padel2Section.className = 'padel-section padel2';
                const padel2Label = document.createElement('div');
                padel2Label.className = 'padel-label padel2';
                padel2Label.textContent = 'Campo 2';
                padel2Section.appendChild(padel2Label);
                
                const padel2Bookings = bookings.filter(b => b.date === dateStr && b.field === 'padel2');
                bookingsCount += padel2Bookings.length;
                padel2Bookings.slice(0, 2).forEach(booking => {
                    const bookingDiv = document.createElement('div');
                    bookingDiv.className = 'padel-booking padel2';
                    bookingDiv.textContent = `${booking.startTime}`;
                    bookingDiv.title = booking.clientName;
                    padel2Section.appendChild(bookingDiv);
                });
                
                padelSplit.appendChild(padel1Section);
                padelSplit.appendChild(padel2Section);
                dayDiv.appendChild(padelSplit);
                
                const totalBookings = padel1Bookings.length + padel2Bookings.length;
                if (totalBookings > 4) {
                    const moreDiv = document.createElement('div');
                    moreDiv.style.fontSize = '10px';
                    moreDiv.style.opacity = '0.7';
                    moreDiv.style.textAlign = 'center';
                    moreDiv.textContent = `+${totalBookings - 4}`;
                    dayDiv.appendChild(moreDiv);
                }
            } else {
                // Normal view for other fields
                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-header';
                dayNumber.textContent = day;
                dayDiv.appendChild(dayNumber);
                
                const dayBookings = bookings.filter(b => b.date === dateStr && b.field === selectedField);
                bookingsCount = dayBookings.length;
                
                dayBookings.forEach((booking, index) => {
                    if (index < 3) {
                        const bookingDiv = document.createElement('div');
                        // Apply sport-specific class for tennis field
                        if (booking.field === 'tennis' && booking.sport) {
                            bookingDiv.className = `booking-slot sport-${booking.sport}`;
                        } else {
                            bookingDiv.className = 'booking-slot';
                        }
                        bookingDiv.innerHTML = `<span class="time">${booking.startTime}</span> ${booking.clientName}`;
                        dayDiv.appendChild(bookingDiv);
                    }
                });
                
                if (dayBookings.length > 3) {
                    const moreDiv = document.createElement('div');
                    moreDiv.style.fontSize = '11px';
                    moreDiv.style.opacity = '0.7';
                    moreDiv.textContent = `+${dayBookings.length - 3} altre...`;
                    dayDiv.appendChild(moreDiv);
                }
            }
            
            // Set bookings count for mobile view
            dayDiv.setAttribute('data-bookings-count', bookingsCount || '0');
            
            dayDiv.onclick = () => showDayDetails(date);
            
            return dayDiv;
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function previousMonth() {
            displayedMonth.setMonth(displayedMonth.getMonth() - 1);
            updateMonthlyCalendar();
        }

        function nextMonth() {
            displayedMonth.setMonth(displayedMonth.getMonth() + 1);
            updateMonthlyCalendar();
        }

        function currentMonth() {
            displayedMonth = new Date();
            updateMonthlyCalendar();
        }

        // Day details
        function showDayDetails(date) {
            const dateStr = formatDate(date);
            let dayBookings;
            
            if (selectedField === 'padel') {
                // Show both padel fields
                dayBookings = bookings.filter(b => b.date === dateStr && (b.field === 'padel1' || b.field === 'padel2'));
                dayBookings.sort((a, b) => {
                    if (a.field !== b.field) return a.field.localeCompare(b.field);
                    return a.startTime.localeCompare(b.startTime);
                });
            } else {
                dayBookings = bookings.filter(b => b.date === dateStr && b.field === selectedField);
                dayBookings.sort((a, b) => a.startTime.localeCompare(b.startTime));
            }
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('modalDate').textContent = date.toLocaleDateString('it-IT', options);
            
            const modalBookings = document.getElementById('modalBookings');
            modalBookings.innerHTML = '';
            
            if (dayBookings.length === 0) {
                modalBookings.innerHTML = '<p>Nessuna prenotazione per questo giorno.</p>';
            } else {
                dayBookings.forEach(booking => {
                    const fieldInfo = fieldConfig[booking.field];
                    let displayName = fieldInfo.name;
                    
                    // Add sport specification for tennis field
                    if (booking.field === 'tennis' && booking.sport) {
                        displayName = booking.sport === 'tennis' ? 'Tennis' : 'Calcio a 5';
                    }
                    
                    const bookingCard = document.createElement('div');
                    bookingCard.className = 'booking-card';
                    bookingCard.innerHTML = `
                        <div class="booking-info">
                            <h4>${fieldInfo.icon} ${displayName} - ${booking.startTime} - ${booking.endTime}</h4>
                            <p><strong>Cliente:</strong> ${booking.clientName}</p>
                            ${booking.phone ? `<p><strong>Telefono:</strong> ${booking.phone}</p>` : ''}
                            ${booking.notes ? `<p><strong>Note:</strong> ${booking.notes}</p>` : ''}
                            <p><small>Creato da ${booking.createdBy}</small></p>
                            ${booking.modifiedBy ? `<p><small>Modificato da ${booking.modifiedBy}</small></p>` : ''}
                        </div>
                        <div class="booking-actions">
                            <button class="edit-btn" onclick="editBooking(${booking.id})">Modifica</button>
                            <button class="delete-btn" onclick="deleteBooking(${booking.id})">Elimina</button>
                        </div>
                    `;
                    modalBookings.appendChild(bookingCard);
                });
            }
            
            document.getElementById('dayModal').style.display = 'block';
        }

        function closeDayModal() {
            document.getElementById('dayModal').style.display = 'none';
        }

        // Bookings list
        function updateBookingsList() {
            const filter = document.getElementById('filterField').value;
            let filteredBookings = bookings;
            
            if (filter) {
                filteredBookings = bookings.filter(b => b.field === filter);
            }
            
            // Sort by date and time
            filteredBookings.sort((a, b) => {
                const dateCompare = a.date.localeCompare(b.date);
                if (dateCompare !== 0) return dateCompare;
                return a.startTime.localeCompare(b.startTime);
            });
            
            const listContainer = document.getElementById('bookingsList');
            listContainer.innerHTML = '';
            
            if (filteredBookings.length === 0) {
                listContainer.innerHTML = '<p>Nessuna prenotazione trovata.</p>';
                return;
            }
            
            filteredBookings.forEach(booking => {
                const fieldInfo = fieldConfig[booking.field];
                let displayName = fieldInfo.name;
                
                // Add sport specification for tennis field
                if (booking.field === 'tennis' && booking.sport) {
                    displayName = booking.sport === 'tennis' ? 'Tennis' : 'Calcio a 5';
                }
                
                const bookingCard = document.createElement('div');
                bookingCard.className = 'booking-card';
                bookingCard.innerHTML = `
                    <div class="booking-info">
                        <h4>${fieldInfo.icon} ${displayName} - ${booking.date}</h4>
                        <p>${booking.startTime} - ${booking.endTime} - ${booking.clientName}</p>
                        ${booking.phone ? `<p>Tel: ${booking.phone}</p>` : ''}
                        ${booking.modifiedBy ? `<p><small>Modificato da ${booking.modifiedBy}</small></p>` : ''}
                    </div>
                    <div class="booking-actions">
                        <button class="edit-btn" onclick="editBooking(${booking.id})">Modifica</button>
                        <button class="delete-btn" onclick="deleteBooking(${booking.id})">Elimina</button>
                    </div>
                `;
                listContainer.appendChild(bookingCard);
            });
        }

        function filterBookings() {
            updateBookingsList();
        }

        function deleteBooking(id) {
            if (confirm('Eliminare questa prenotazione?')) {
                bookings = bookings.filter(b => b.id !== id);
                saveData();
                
                // Delete from Google Sheets if configured
                if (checkGoogleSheetsConfig()) {
                    deleteFromGoogleSheets(id);
                }
                
                updateAllViews();
                closeDayModal();
                showSuccess('Prenotazione eliminata!');
            }
        }

        // Close modal on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Show sync options
        function showSyncOptions() {
            const configStatus = document.getElementById('configStatus');
            if (checkGoogleSheetsConfig()) {
                configStatus.textContent = '✅ Google Sheets configurato e attivo!';
                configStatus.style.color = '#2e7d32';
            } else {
                configStatus.textContent = '❌ Google Sheets non configurato - Segui le istruzioni sotto';
                configStatus.style.color = '#d32f2f';
            }
            document.getElementById('syncModal').style.display = 'block';
        }
        
        function closeSyncModal() {
            document.getElementById('syncModal').style.display = 'none';
        }
        
        // Export data
        function exportData() {
            const dataToExport = {
                bookings: bookings,
                exportDate: new Date().toISOString(),
                exportedBy: users[currentUser].name
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `prenotazioni-centro-sportivo-${formatDate(new Date())}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showSuccess('Dati esportati con successo!');
        }
        
        // Import data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.bookings && Array.isArray(importedData.bookings)) {
                        if (confirm(`Vuoi sostituire tutti i dati esistenti con quelli importati? (${importedData.bookings.length} prenotazioni)`)) {
                            bookings = importedData.bookings;
                            saveData();
                            updateAllViews();
                            showSuccess('Dati importati con successo!');
                            closeSyncModal();
                        }
                    } else {
                        alert('File non valido!');
                    }
                } catch (error) {
                    alert('Errore durante l\'importazione del file!');
                    console.error(error);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }
        
        // Auto-save on page unload
        window.addEventListener('beforeunload', saveData);
        
        // Handle orientation change
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                if (currentView === 'weekly') {
                    updateWeeklyCalendar();
                } else {
                    updateMonthlyCalendar();
                }
            }, 100);
        });
        
        // Handle resize for responsive adjustments
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (document.getElementById('calendarSection').classList.contains('active')) {
                    if (currentView === 'weekly') {
                        updateWeeklyCalendar();
                    } else {
                        updateMonthlyCalendar();
                    }
                }
            }, 250);
        });
        
        // Touch swipe support for calendar navigation
        let touchStartX = 0;
        let touchEndX = 0;
        let isScrolling = false;
        
        function handleSwipe() {
            if (isScrolling) return;
            
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // Swipe left - next period
                    if (currentView === 'weekly') {
                        nextWeek();
                    } else {
                        nextMonth();
                    }
                } else {
                    // Swipe right - previous period
                    if (currentView === 'weekly') {
                        previousWeek();
                    } else {
                        previousMonth();
                    }
                }
            }
        }
        
        // Add swipe listeners to calendar containers
        function initializeSwipeListeners() {
            const weeklyCalendar = document.querySelector('.weekly-calendar');
            const monthlyWrapper = document.getElementById('calendarWrapper');
            
            // Track scrolling on weekly calendar
            if (weeklyCalendar) {
                weeklyCalendar.addEventListener('scroll', () => {
                    isScrolling = true;
                    clearTimeout(window.scrollTimeout);
                    window.scrollTimeout = setTimeout(() => {
                        isScrolling = false;
                    }, 150);
                });
            }
            
            // Only add swipe to monthly view and weekly wrapper (not scrollable area)
            [monthlyWrapper].forEach(wrapper => {
                if (wrapper) {
                    wrapper.addEventListener('touchstart', (e) => {
                        touchStartX = e.changedTouches[0].screenX;
                    }, { passive: true });
                    
                    wrapper.addEventListener('touchend', (e) => {
                        touchEndX = e.changedTouches[0].screenX;
                        handleSwipe();
                    }, { passive: true });
                }
            });
        }
        
        // Initialize swipe listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeSwipeListeners);
        
        // Cleanup on logout
        function cleanup() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }
    </script>
</body>
</html>
